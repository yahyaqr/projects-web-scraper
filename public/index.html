<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Scraper</title>
    <link rel="stylesheet" href="styles.css" type="text/css">
</head>

<body>
    <h1>Web Scraper</h1>
    <form id="scraperForm" enctype="multipart/form-data">
        <label for="htmlFile">Upload HTML file to scrape:</label>
        <input type="file" id="htmlFile" accept=".html,.htm" required>
        <p>Upload an HTML file containing the data to scrape.</p>

        <h3>Scraping Steps</h3>

        <!-- Tabs for steps -->
        <div id="stepsTabs">
            <ul id="tabsList">
                <li class="tab active" data-step="1">Step 1</li>
            </ul>
            <div id="tabsContent">
                <!-- Content for Step 1 -->
                <div class="tabContent active" data-step="1">
                    <h4>Step 1</h4>
                    <label>
                        <input type="checkbox" id="goToInnerLinks_1" class="goToInnerLinks" data-step="1">
                        Go to links inside this step
                    </label>

                    <div class="innerLinkSelectorContainer" style="display: none;">
                        <label for="innerLinkSelector_1">Selector for inner links:</label>
                        <input type="text" id="innerLinkSelector_1" placeholder="e.g., a.link-class">
                        <p>Enter the CSS selector for links to follow inside this step.</p>
                    </div>

                    <label for="stepDataHeaders_1">Data Headers (comma-separated):</label>
                    <textarea id="stepDataHeaders_1" rows="3" placeholder="e.g., Nama Tender, Nilai Pagu Paket"
                        required></textarea>
                    <p>Enter the data headers separated by commas for this step.</p>

                    <label for="stepDataSelectors_1">CSS Selectors (one per line):</label>
                    <textarea id="stepDataSelectors_1" rows="5"
                        placeholder="e.g.,&#10;tr:contains('Nama Tender') td strong" required></textarea>
                    <p>Enter the CSS selectors, one per line, corresponding to each header.</p>
                </div>
            </div>
        </div>

        <button type="button" id="addStep">Add Scraping Step</button>
        <button type="submit">Start Scraping</button>
    </form>

    <h3>Mockup Preview</h3>
    <table id="previewTable" border="1" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr>
                <!-- Headers will be added dynamically -->
            </tr>
        </thead>
        <tbody>
            <tr>
                <!-- Placeholder row 1 -->
            </tr>
            <tr>
                <!-- Placeholder row 2 -->
            </tr>
        </tbody>
    </table>

    <div id="result"></div>
    <div id="errorLog" style="margin-top: 20px; color: red;"></div>

    <script>
        const form = document.getElementById('scraperForm');
        const tabsList = document.getElementById('tabsList');
        const tabsContent = document.getElementById('tabsContent');
        const addStepButton = document.getElementById('addStep');
        const errorLogDiv = document.getElementById('errorLog');
        let stepCount = 1;

        // Handle "Go to links inside this step" for Step 1
        document.querySelector('#goToInnerLinks_1').addEventListener('change', function () {
            const innerLinkSelectorContainer = document.querySelector('.innerLinkSelectorContainer');
            innerLinkSelectorContainer.style.display = this.checked ? 'block' : 'none';
        });

        // Event listener to switch between tabs
        tabsList.addEventListener('click', (e) => {
            if (e.target.tagName === 'LI' && e.target.classList.contains('tab')) {
                const step = e.target.dataset.step;

                // Highlight selected tab
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');

                // Show corresponding tab content
                document.querySelectorAll('.tabContent').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelector(`.tabContent[data-step="${step}"]`).classList.add('active');
            }
        });

        // Add new step as a tab
        addStepButton.addEventListener('click', () => {
            stepCount++;

            // Add new tab
            const newTab = document.createElement('li');
            newTab.classList.add('tab');
            newTab.dataset.step = stepCount;
            newTab.textContent = `Step ${stepCount}`;
            tabsList.appendChild(newTab);

            // Add content for the new tab
            const newTabContent = document.createElement('div');
            newTabContent.classList.add('tabContent');
            newTabContent.dataset.step = stepCount;
            newTabContent.innerHTML = `
                <h4>Step ${stepCount}</h4>
                <label for="innerLinkSelector_${stepCount}">Selector for links to navigate to this step:</label>
                <input type="text" id="innerLinkSelector_${stepCount}" placeholder="e.g., a.link-class" required>
                <p>Enter the CSS selector for links to navigate to this step.</p>
    
                <label for="stepDataHeaders_${stepCount}">Data Headers (comma-separated):</label>
                <textarea id="stepDataHeaders_${stepCount}" rows="3" placeholder="e.g., Header1, Header2" required></textarea>
                <p>Enter the data headers separated by commas for this step.</p>
    
                <label for="stepDataSelectors_${stepCount}">CSS Selectors (one per line):</label>
                <textarea id="stepDataSelectors_${stepCount}" rows="5" placeholder="e.g., Selector1&#10;Selector2" required></textarea>
                <p>Enter the CSS selectors, one per line, corresponding to each header.</p>
            `;
            tabsContent.appendChild(newTabContent);

            // Switch to the new tab
            newTab.click();
        });

        // Submit form logic
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const fileInput = document.getElementById('htmlFile');
            if (fileInput.files.length === 0) {
                alert('Please select an HTML file to upload.');
                return;
            }

            const steps = [];
            document.querySelectorAll('.tabContent').forEach((step, index) => {
                const stepNumber = index + 1;
                const headers = step.querySelector(`#stepDataHeaders_${stepNumber}`).value.split(',').map(h => h.trim());
                const selectors = step.querySelector(`#stepDataSelectors_${stepNumber}`).value.split('\n').map(s => s.trim());
                const innerLinkSelector = step.querySelector(`#innerLinkSelector_${stepNumber}`)?.value || null;

                if (headers.length !== selectors.length) {
                    alert(`The number of headers and selectors must match in Step ${stepNumber}.`);
                    return;
                }

                steps.push({ headers, selectors, innerLinkSelector });
            });

            const formData = new FormData();
            formData.append('htmlFile', fileInput.files[0]);
            formData.append('steps', JSON.stringify(steps));

            try {
                const response = await fetch('/scrape', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error('Failed to fetch valid JSON response from server.');
                }

                const result = await response.json();
                console.log('Scraping completed successfully.', result);
            } catch (error) {
                const errorMessage = `Error: ${error.message || 'An unknown error occurred.'}`;
                console.error(errorMessage);
                errorLogDiv.textContent = errorMessage;
                errorLogDiv.style.display = 'block';
            }
        });
    </script>

</body>

</html>