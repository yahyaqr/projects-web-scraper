<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Scraper</title>
    <link rel="stylesheet" href="styles.css" type="text/css">
</head>

<body>
    <h1>Web Scraper</h1>
    <form id="scraperForm" enctype="multipart/form-data">
        <label for="htmlFile">Upload HTML file to scrape:</label>
        <input type="file" id="htmlFile" accept=".html,.htm" required>
        <p>Upload an HTML file containing the data to scrape.</p>

        <label>
            <input type="checkbox" id="goToInnerLinks"> Go to links inside the uploaded file
        </label>
        <p>Check this if you want to scrape additional links from the uploaded file.</p>

        <div id="innerLinkSelectorContainer" style="display: none;">
            <label for="innerLinkSelector">Selector for inner links:</label>
            <input type="text" id="innerLinkSelector" placeholder="e.g., a.link-class">
            <p>Enter the CSS selector for links to follow inside the uploaded file.</p>
        </div>

        <div>
            <label for="maxData">Max data to retrieve:</label>
            <input type="number" id="maxData" value="100" min="1">
            <p>Specify the maximum number of data entries to scrape.</p>
        </div>

        <div>
            <label for="dataPerFile">Max data per file:</label>
            <input type="number" id="dataPerFile" value="50" min="1">
            <p>Set how many data entries should be saved per file.</p>
        </div>

        <h3>Data Headers and Selectors</h3>
        <label for="dataHeaders">Data Headers (comma-separated):</label>
        <textarea id="dataHeaders" rows="3"
            placeholder="e.g., Nama Tender, Nilai Pagu Paket, Lokasi Pekerjaan, Pemenang" required></textarea>
        <p>Enter the data headers separated by commas. Example: <i>Nama Tender, Nilai Pagu Paket, Lokasi Pekerjaan,
                Pemenang</i>.</p>

        <label for="dataSelectors">CSS Selectors (one per line):</label>
        <textarea id="dataSelectors" rows="5"
            placeholder="e.g.,&#10;tr:contains('Nama Tender') td strong&#10;tr:contains('Nilai Pagu Paket') td:nth-of-type(1)&#10;tr:contains('Lokasi Pekerjaan') ul li&#10;a.nav-link:contains('Pemenang')"
            required></textarea>
        <p>Enter the CSS selectors, one per line, corresponding to each header. The number of selectors must match the
            number of headers.</p>

        <h3>Navigation for Additional Data</h3>
        <label for="navLinks">Navigation Links (one per line):</label>
        <textarea id="navLinks" rows="3" placeholder="e.g.,&#10;a.nav-link:contains('Pemenang')" required></textarea>
        <p>Enter the CSS selectors for navigation links that need to be clicked for additional data.</p>

        <label for="navHeaders">Headers for Data from Navigation Links (comma-separated):</label>
        <textarea id="navHeaders" rows="3" placeholder="e.g., Nama Pemenang, Nilai Kontrak" required></textarea>
        <p>Enter the headers for data retrieved after clicking each navigation link.</p>

        <label for="navSelectors">Selectors for Data from Navigation Links (one per line):</label>
        <textarea id="navSelectors" rows="5" placeholder="e.g.,&#10;div.pemenang-name&#10;div.kontrak-value"
            required></textarea>
        <p>Enter the CSS selectors for data retrieved after clicking each navigation link. The number of selectors must
            match the headers for navigation links.</p>

        <button type="submit">Start Scraping</button>
    </form>

    <h3>Mockup Preview</h3>
    <table id="previewTable" border="1" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr>
                <!-- Headers will be added dynamically -->
            </tr>
        </thead>
        <tbody>
            <tr>
                <!-- Placeholder row 1 -->
            </tr>
            <tr>
                <!-- Placeholder row 2 -->
            </tr>
        </tbody>
    </table>

    <div id="progressContainer" style="margin-top: 20px; display: none;">
        <label for="progressBar">Processing Progress:</label>
        <progress id="progressBar" value="0" max="100" style="width: 100%;"></progress>
        <span id="progressText">0%</span>
    </div>

    <div id="result"></div>
    <div id="errorLog" style="margin-top: 20px; color: red;"></div>

    <script>
        const form = document.getElementById('scraperForm');
        const goToInnerLinksCheckbox = document.getElementById('goToInnerLinks');
        const innerLinkSelectorContainer = document.getElementById('innerLinkSelectorContainer');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const errorLogDiv = document.getElementById('errorLog');

        // Show or hide the inner link selector input
        goToInnerLinksCheckbox.addEventListener('change', function () {
            innerLinkSelectorContainer.style.display = this.checked ? 'block' : 'none';
        });

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            progressContainer.style.display = 'block';
            progressBar.value = 0;
            progressText.textContent = '0%';

            const fileInput = document.getElementById('htmlFile');
            const headersInput = document.getElementById('dataHeaders').value.split(',').map(header => header.trim());
            const selectorsInput = document.getElementById('dataSelectors').value.split('\n').map(selector => selector.trim());
            const navLinksInput = document.getElementById('navLinks').value.split('\n').map(link => link.trim());
            const navHeadersInput = document.getElementById('navHeaders').value.split(',').map(header => header.trim());
            const navSelectorsInput = document.getElementById('navSelectors').value.split('\n').map(selector => selector.trim());

            if (headersInput.length !== selectorsInput.length) {
                alert('The number of headers and selectors must match.');
                return;
            }

            if (navHeadersInput.length !== navSelectorsInput.length) {
                alert('The number of navigation headers and selectors must match.');
                return;
            }

            const maxData = document.getElementById('maxData').value;
            const dataPerFile = document.getElementById('dataPerFile').value;

            if (fileInput.files.length === 0) {
                alert('Please select an HTML file to upload.');
                return;
            }

            const formData = new FormData();
            formData.append('htmlFile', fileInput.files[0]);
            formData.append('goToInnerLinks', goToInnerLinksCheckbox.checked);
            formData.append('maxData', maxData);
            formData.append('dataPerFile', dataPerFile);
            formData.append('navLinks', JSON.stringify(navLinksInput));
            formData.append('navHeaders', JSON.stringify(navHeadersInput));
            formData.append('navSelectors', JSON.stringify(navSelectorsInput));

            const dataSelectors = {};
            headersInput.forEach((header, index) => {
                dataSelectors[header] = selectorsInput[index];
            });
            formData.append('dataSelectors', JSON.stringify(dataSelectors));

            try {
                const response = await fetch('/scrape', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error('Failed to fetch valid JSON response from server.');
                }

                const result = await response.json();
                result.forEach((progress, index) => {
                    progressBar.value = progress.percentage;
                    progressText.textContent = `${progress.percentage}%`;
                });
            } catch (error) {
                const errorMessage = `Error: ${error.message || 'An unknown error occurred.'}`;
                console.error(errorMessage); // Log to the browser console
                errorLogDiv.textContent = errorMessage; // Display error in the error log div
                errorLogDiv.style.display = 'block'; // Ensure the error log div is visible
            }
        });
    </script>
</body>

</html>